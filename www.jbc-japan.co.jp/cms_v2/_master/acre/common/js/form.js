/*
 * form.js for Akibare Homepage
 * pxg
 */
!function(t){"use strict";function r(t){return this.init(t)}t(function(){var n=t('form[action$="form_records"]');n.length&&n.each(function(){var n=t(this);new r(n)})}),r.prototype={REPLACE_REG:function(){return new RegExp(/form_record\[([^\]]+)\]/)}(),init:function(t){var r=this;return r.$form=t,r.submitting=!1,r.preview=!1,"true"===t.attr("data-confirm-preview")&&(r.preview=!0),r._getInputs(),r._addConfirms(),r._eventify(),r},_eventify:function(){var t=this;t.$form.on("click",".mod-form-submit-button input",function(r){return t.submitting===!0?!1:(r.preventDefault(),void t._submit(!0))}).on("click",".mod-form-edit",function(r){r.preventDefault(),t._clearConfirm()}).on("submit",function(r){return t.submitting===!0?!1:(t.submitting=!0,r.preventDefault(),void t._submit())})},_getInputs:function(){var r=this,n=r.$form,i={};r.$inputs=n.find(['input[type="text"]','input[type="checkbox"]','input[type="radio"]',"textarea","select"].join(",")).each(function(){var e=this.getAttribute("name").replace(/\[\]$/,""),o=this.getAttribute("type");return e=e.replace(r.REPLACE_REG,"$1"),"checkbox"===o||"radio"===o?(/\[\]$/.test(this.name)||(this.name=this.name+"[]"),i[e]={type:o,$input:t(this).parent().parent(),$inputs:n.find('[name="'+this.name+'"]')}):void(i[e]={type:"default",$input:t(this)})}),r.mapped=i},_addConfirms:function(){var r=this,n=r.mapped,i=r.$form.find(".mod-form-confirm-button"),e=r.$form.find(".mod-form-submit-button");t.each(n,function(r,i){var e=i.$input,o=t("<span>").addClass("mod-formConfirm").hide();e.after(o),n[r].$confirm=o}),r.$confirmBtnSet=i,r.$submitBtn=e,r.preview?(r.$confirmBtnSet.hide(),r.$submitBtn.show()):(r.$confirmBtnSet.show(),r.$submitBtn.hide(),r.$confirmBtnSet.find('[type="button"]').hide()),r.mapped=n},_submit:function(r){var n=this,i=n.$form,e=i.attr("action"),o=e;r&&(o+="?preview=true"),t.ajax({type:"POST",url:o,dataType:"json",data:i.serialize()}).always(function(){n.submitting=!1}).done(function(t){r?n._showConfirm():n._xhrSuccess(t)}).fail(function(t,r,i){return 500===t.status?alert("サーバーエラーが発生しました。"):void n._xhrError(t)})},_xhrSuccess:function(t){var r=this;r._clearErrors(),t.redirect_to&&"/page_redirect?page_id="!==t.redirect_to?location.href=t.redirect_to:location.href=location.href},_xhrError:function(r){var n=this,i=r.responseText,e=t.parseJSON(i)||i;"object"==typeof e&&"errors"in e?n._showErrors(e.errors):n._showAlerts()},_scrollToTop:function(){var r=this,n=r._getFormPosition(),i=t("html,body");i.animate({scrollTop:n.top},{easing:"swing",duration:250})},_getFormPosition:function(){var t=this;return t.$form.offset()},_showAlerts:function(){alert("サーバー通信エラーが発生しました。時間を置いてお試しください。")},_showConfirm:function(){var r=this,n=r.mapped;r._clearErrors(),t.each(n,function(t,r){var n,i=r.$inputs?r.$inputs:r.$input,e=r.$confirm,o=r.type;"checkbox"===o||"radio"===o?(n="",i.each(function(t,r){r.checked&&(n=n+", "+r.value)}),n=n.replace(/^, /,"")):n=i.val(),n=n.replace(/(?:\n\r?)|(?:\r\n?)/g,"<br>"),e.html(n).show(),r.$inputs&&(i=r.$input),i.hide()}),r.$confirmBtnSet.show(),r.$submitBtn.hide(),r._scrollToTop()},_clearConfirm:function(){var r=this,n=r.mapped;t.each(n,function(t,r){var n=r.$input,i=r.$confirm;i.hide(),n.show()}),r.preview&&(r.$confirmBtnSet.hide(),r.$submitBtn.show()),r._scrollToTop()},_showErrors:function(r){var n=this,i=n.mapped,e=[];n._clearConfirm(),n._clearErrors(),t.each(r,function(r,n){var o=i[r].$input,s=t("<span>").addClass("mod-formError").text(n);o.addClass("mod-formError-notice"),o.after(s),i[r].$error=s,e.push(i[r])}),n.errors=e},_clearErrors:function(){var r=this,n=r.errors||[];t.each(n,function(t,r){r.$input.removeClass("mod-formError-notice"),r.$error.remove()}),r.errors=[]}}}(jQuery);